name: macOS

on: [push, pull_request]

jobs:
  test:
    name: ${{matrix.compiler.cc}}
    runs-on: macos-latest

    env:
      build-directory: build

    strategy:
      fail-fast: false
      matrix:
        compiler:
          # - { name: "xcode", version: "12.4" }

          # Clang Versions
          - { cc: clang-11, cxx: clang++-11, lib: llvm@11 }

    steps:
      - name: Clone
        uses: actions/checkout@v2

      - name: Prepare Environment
        run: |
          brew install ${{matrix.compiler.lib}}

          echo "$(brew --prefix llvm)/bin" >> ${GITHUB_PATH}

          # ls -ls /Applications/
          # sudo xcode-select -switch /Applications/Xcode_${{ matrix.compiler.version }}.app

          cmake -E make_directory ${{env.build-directory}}

      # Debug Configuration

      - name: Configure (Debug)
        working-directory: ${{env.build-directory}}
        env:
          CC: clang
          CXX: clang++
        run: cmake .. -DCMAKE_BUILD_TYPE=Debug -DMSL_ENABLE_UNIT_TESTS=On

      - name: Build (Debug)
        working-directory: ${{env.build-directory}}
        run: cmake --build .

      - name: Test (Debug)
        working-directory: ${{env.build-directory}}
        run: ctest --output-on-failure

      # Release Configuration

      - name: Configure (Release)
        working-directory: ${{env.build-directory}}
        run: cmake .. -DCMAKE_BUILD_TYPE=Release

      - name: Build (Release)
        working-directory: ${{env.build-directory}}
        run: cmake --build .

      - name: Test (Release)
        working-directory: ${{env.build-directory}}
        run: ctest --output-on-failure

  # sanitize:
  #   name: Xcode ${{matrix.compiler.version}} '${{matrix.sanitizer}}' sanitizer
  #   runs-on: macos-latest
  #   needs: test

  #   env:
  #     build-directory: build

  #   strategy:
  #     matrix:
  #       sanitizer: [address, undefined]

  #   steps:
  #     - name: Clone
  #       uses: actions/checkout@v2

  #     - name: Prepare Environment
  #       run: |
  #         cmake -E make_directory ${{env.build-directory}}

  #     - name: Configure
  #       working-directory: ${{env.build-directory}}
  #       env:
  #         CC: clang
  #         CXX: clang++
  #       run: cmake .. -DCMAKE_BUILD_TYPE=Debug -DMSL_ENABLE_UNIT_TESTS=On -DCMAKE_CXX_FLAGS="-fsanitize=${{matrix.sanitizer}}"

  #     - name: Build
  #       working-directory: ${{env.build-directory}}
  #       run: cmake --build .

  #     - name: Test (Sanitize)
  #       working-directory: ${{env.build-directory}}
  #       run: ctest --output-on-failure
